<script type="text/x-template" id="file_upload_m">
<div class="file_upload_m_control">
    <div v-repeat="f : files">
        <i v-file-icon="f.suffix"></i>
        <a v-href="f.file_path" target="_blank" v-class="remove-mark: f.remove==true">(% f.file_name %)</a>
        <i class="fa fa-times btn-remove-file" v-on="click: removeFile(f)"></i>
    </div>
    <div v-repeat="f : append_files">
        <i v-file-icon="f.suffix"></i>
        <a v-href="f.file_path" target="_blank" v-class="remove-mark: f.remove==true">(% f.file_name %)</a>
        <i class="fa fa-times btn-remove-file" v-on="click: removeFile(f)"></i>
    </div>
    <button class="btn-file btn btn-success" v-on="click:uploadFiles">开始上传</button> 
    <span class="file-input btn btn-sm btn-primary btn-file">
        选择文件<input v-on="change: appendFile($event)" type="file" multiple/>
    </span>
</div>
</script>
<script type="text/javascript">
// 把disabled和href合并了
Vue.directive("href", function(value){
    if(value) {
        $(this.el).removeAttr("disabled").attr("href", "/" + value)
    } else {
        $(this.el).attr("disabled", true)
    }
});
// 根据文件的拓展名替换不同的图标
Vue.directive("file-icon", function(value){
    var file_icon = "fa fa-upload";
    if(value == "uploading") {
        file_icon = "fa fa-spin fa-spinner";
    } else if([".xls", ".xlsx"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-excel-o";
    } else if([".doc", ".docx"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-word-o"
    } else if([".doc", ".docx"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-word-o"
    } else if([".ppt", ".pptx"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-powerpoint-o"
    } else if([".zip", ".rar", ".7z"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-archive-o"
    } else if([".txt"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-text-o"
    } else if([".pdf"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-pdf-o"
    } else if([".png", ".jpeg", ".jpg", ".gif"].indexOf(value) >= 0) {
        file_icon = "fa fa-file-image-o"
    } else if(value) {
        file_icon = "fa fa-file-o"
    }
    $(this.el).attr("class", file_icon)
});
// component 本体
// 使用方式 <div v-component="file_upload_m" v-with="field_name: 'test_file'" v-ref="test_file_c"></div>
// 输入field名字，返回上传的ids
Vue.component("file_upload_m", {
    template: "#file_upload_m",
    computed: {
        column: function() {
            return this.field_name   // 上传用的字段名标记
        }
    },
    attached: function() {
        // 因为数据的显示传递会覆盖data对象，所以改成在attached方法中声明
        this.$set("upload_ids", [])         // 上传成功后的id
        this.$set("append_files", []);      // 新增的文件
        this.getExistFiles();
    },
    methods: {
        getExistFiles: function() {
            _this = this
            if(!_this.id) {
                _this.$set("files", []);
            } else {
            parms_str = [this.table_name, this.column, this.id].join("/")
                $.get("/file_upload/" + parms_str)
                .done(function(d) {
                    _this.$set("files", d.results);
                    console.log(_this.files)
                });
            }
        },
        appendFile: function(e) {
            var files = e.target.files
            for(var i in files) {
                if(!isNaN(i)) {
                    var f = files[i];
                    var fd = new FormData();
                    fd.append("file_" + i, f);
                    // 把文件放入到 all_files列表和 fd上传队列中
                    var new_file = {
                        "file_type": "file",    // 文件类型
                        "file_name": f.name,    // 文件名 -- 来源于input[type=file]
                        "remove": false,        // 删除标记
                        "suffix": null,         // 文件拓展名
                        "fd": fd                // 上传文件用的formData
                    }
                    this.append_files.push(new_file)
                }
            }
        },
        removeFile: function(f) {
            _this = this
            if(confirm("是否确定删除文件:" + f.file_name + "?")) {
                $.post("/file_ref",JSON.stringify({"remove_files": [f.id]}))
                .done(function(d) {
                    if(d.error == "0") {
                        _this.files.splice(_this.files.indexOf(f), 1);
                        console.log("删除成功");
                    } else {
                        console.log("失败什么的");
                    }
                });
            }
        },
        uploadFiles: function() {
            _this = this
            _this.append_files.forEach(function(file, index) {
                file.suffix = "uploading"
                $.ajax({
                    url: "/file_upload",
                    type:"POST",
                    data: file.fd,
                    processData: false,
                    contentType: false
                }).done(function(d) {
                    _this.upload_ids.push(d.results[0].file_id);
                    _this.append_files.splice(_this.append_files.indexOf(file), 1);
                    _this.files.push(d.results[0])
                });
            });
        },
        // 默认的关联方法
        createFileRef: function(){
            if(!this.id) {
                console.log("请在调用之前先提交外部表单。");
            } else {
                params = {
                    "column": this.column,
                    "table_name": this.table_name,
                    "record_id": this.id,
                    "upload_ids": this.upload_ids
                }
                $.post(
                    "/file_ref",
                    JSON.stringify(params)
                ).done(function(data) {
                    console.log(data)
                });
            }
        }
    }
});
</script>
{"version":3,"sources":["crud_m.coffee"],"names":[],"mappings":"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","file":"crud_m.js","sourceRoot":"/source/","sourcesContent":["$ ->\n    Vue.directive('model-checkbox',\n        twoWay: true\n        bind:(value) ->\n            @checkboxChange = (->\n                if @el.checked\n                    dataKeys = @raw.split(\".\")\n                    dataContainer = @vm.$data\n                    i = 0\n                    for dataKey in dataKeys\n                        if !dataContainer[dataKey] && (i + 1) != dataKeys.length\n                            dataContainer[dataKey] = {}\n                        if (i + 1) != dataKeys.length\n                            dataContainer = dataContainer[dataKey]\n                        i++\n                    if dataContainer[dataKeys[dataKeys.length - 1]]\n                        dataContainer[dataKeys[dataKeys.length - 1]] = dataContainer[dataKeys[dataKeys.length - 1]] + \",\" + @el.value\n                    else\n                        dataContainer[dataKeys[dataKeys.length - 1]] = @el.value\n                else\n                    dataKeys = @raw.split(\".\")\n                    dataContainer = @vm.$data\n                    i = 0\n                    for dataKey in dataKeys\n                        if (i + 1) != dataKeys.length\n                            dataContainer = dataContainer[dataKey]\n                        i++\n                    _valuesStr = dataContainer[dataKeys[dataKeys.length - 1]]\n                    if !_valuesStr\n                        return\n                    _values = _valuesStr.split(\",\")\n                    _newValuesStr = \"\"\n                    for _value in _values\n                        if _value != @el.value\n                            if _newValuesStr == \"\"\n                                _newValuesStr = _value\n                            else\n                                _newValuesStr = _newValuesStr + \",\" + _value\n                    dataContainer[dataKeys[dataKeys.length - 1]] = _newValuesStr\n            ).bind(@)\n            @el.addEventListener('change', @checkboxChange)\n            @checkboxChange()\n        update:(value) ->\n            _checkedValues = @vm.$data.record.sex\n            if _checkedValues && _checkedValues.indexOf(@el.value) != -1\n                @el.checked = true\n        unbind:() ->\n            @el.removeEventListener('change', @checkboxChange)\n    )\n    \n    v_crud = new Vue\n        el: '#v_crud'\n        data:\n            editable: true\n            record:{}\n            loading:false\n            oper:''\n            table_desc:''\n            files:[]\n        watch:\n            'record':->\n                $('#wysiwyg').html(@record.content)\n                window.bz.initWysiwyg(@)\n        methods:\n            setRichText:(value)->\n                @record.content = value\n            toggleEdit:->\n                if @$data.editable\n                    @$data.editable = false\n                else\n                    @$data.editable = true\n            getTableName:->\n                parm = window.bz.getUrlParm()\n                return parm[2]\n            jump2List:->\n                path = '/crud_list/' + @getTableName()\n                location.pathname = path\n            save:->\n                data = @$data\n                data.loading=true\n                table_name = @getTableName()\n                $.post('/crud_api',\n                  JSON.stringify {table_name:table_name, record:data.record}\n                ).done((result)->\n                    if result.error!='0'\n                        window.bz.showError5(result.error)\n                        log result.error\n                    else if result.error == undefined\n                        data.error_info = '未知错误'\n                    else if data.files.length > 0\n                        uploadFile(data.files)\n                    else\n                        AllDone(result)\n                )\n\n    AllDone = (d)->\n        v_crud.$set(\"loading\", false)\n        if d.error == \"0\"\n            #delay 1500, -> v_crud.jump2List()\n            window.bz.showSuccess5('提交成功...正在返回列表')\n        else\n            window.bz.showError5(d)\n\n    uploadFile = (files)->\n        files.forEach (file)->\n            if file.temp.fd\n                $.ajax\n                    url: \"/file_upload\",\n                    type:\"POST\",\n                    data: file.temp.fd,\n                    processData: false,\n                    contentType: false\n                .done (d)->\n                    createFileRef(file, d)\n            else\n                $.post \"/file_ref\",\n                    JSON.stringify \n                        \"remove_files\": file.temp.remove_files\n                .done (d)->\n                    createFileRef(file)\n\n    createFileRef = (file, data)->\n        if not file\n            AllDone()\n            return\n        else if not data\n            params =\n                \"remove_files\": file.temp.remove_files\n        else\n            params =\n                \"column\": file.column\n                \"append_files\": data.results\n                \"remove_files\": file.temp.remove_files\n                \"table_name\": table_name\n                \"record_id\": id\n        $.post \"/file_ref\",\n            JSON.stringify(params)\n        .done(AllDone)\n\n    table_name = v_crud.getTableName()\n    parm = window.bz.getHashParms()\n    id = parm[0].replace('#','')\n    parm = {table_name:table_name}\n    if id!=''\n        v_crud.$data.oper='编辑'\n        parm.id = id\n    else\n        v_crud.$data.oper='新增'\n\n    $.post('/crud',\n      JSON.stringify parm\n    ).done((result)->\n        if result.error!='0'\n            window.bz.showError5(result.error)\n        else\n            v_crud.$data.table_desc = result.table_desc\n            if result.data.length>0\n                record = result.data[0]\n                for field of record\n                    if record[field] != null and typeof record[field] == \"object\"\n                        record[field] = JSON.stringify(record[field])\n                v_crud.$data.record = result.data[0]\n                v_crud.$data.record.id = id\n            else if id!=''\n                window.bz.showError5('未找到这条数据!')\n            # 生成数据交换属性, 并且打包到files中\n            if result.all_files\n                if result.all_files.length > 0\n                    for f in result.all_files\n                        v_crud.$set(f.column, {\"fd\": null, \"all_files\": f.files, \"remove_files\": []})\n                        v_crud.$data.files.push({\"column\": f.column, \"temp\": v_crud.$data[f.column]})\n    )\n\n"]}